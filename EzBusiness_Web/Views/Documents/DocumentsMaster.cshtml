@model IEnumerable<EzBusiness_ViewModels.Models.Humanresourcepayroll.DocumentsVM>
@{
    ViewBag.Title = "DocumentsMaster";
    var counter = 1;
}



@*@Scripts.Render("~/bundles/jquery")*@


@*<script src="~/Content/assets/js/jquery.dataTables.min.js"></script>*@
<script src="~/Scripts/EzComNDW.js"></script>
<script>
    $(function () {
        EzAuthentication("/Documents");
        var n = EzAuthenticationBtn("/DutyResume", "ViewIt");
        if (n == 1) {
            Ezsidetbl("#tblUnits1", "#tblUnits1 tfoot th", true);
            $('#tblUnits').show();

        } else {
            $('#tblUnits').hide();
        }
    });
</script>



<script>
    var Doks = [];
    $(function () {
        $("#tblUnits1").hide();
       // GetUnitTypes();
        $("#btnAdd").click(function () {
            var n = EzAuthenticationBtn("/DutyResume", "NewIt");
            if (n == 1) {
                $("#tbldiv").hide();
                $("#btnAdd").prop('disabled', true)
                $("#btnCancel").prop("disabled", false);
                $("#btnSave").prop("disabled", false);
                $("[name*='Edit']").prop('disabled', true)
                $("[name*='Delete']").prop('disabled', true)
                $("#tblUnits1 tbody tr").css("background", "");
                $("#tblUnits1").show();
            }
        });

        var counter = $("#Counter").val();


        /*Code Tab Event*/
        EztableTabEve("#tblUnits1", "[name*='txtDocCode']", "[name *= 'txtDocName']", "Please Enter DocCode", 'T',"");
        
        /*Enter Event*/
        EztableLstEnt("#tblUnits1", "[name*='txtDocName']", "[name *= 'txtDocCode']","T","");


        /*Add Table Change Event*/
        $("#tblUnits1").on("change", "[name*='txtDocCode']", function () {
            var tr = $(this).closest('tr');
            debugger;
            drec = [];
            $('#tblUnits1 tbody tr td:nth-child(1)').each(function () {
                //add item to array
                var ab = $(this).find("[name *= 'txtDocCode']").val();
                drec.push(ab);
            });

            drec.splice($.inArray(tr.find("[name *= 'txtDocCode']").val(), drec), 1);

            if ($.inArray(tr.find("[name *= 'txtDocCode']").val(), drec) >= 0) {
                var dr = tr.find("[name *= 'txtDocCode']").val();
                tr.css("background", "red");
                tr.find("[name *= 'txtDocCode']").focus();
                alert("Already Exist Code '" + dr + "'");
                tr.find("[name *= 'txtDocCode']").val('');

            }
            else {
                tr.css("background", "");
                if (tr.is(":last-child")) {
                    tr.clone(true, true).insertAfter(tr);
                    var trLast = $("#tableMetaSettings tr:last");
                    $("<td><button type='button' class='btn btn-danger' name='btnDelete" + counter + "')'><span class='glyphicon glyphicon-remove'></span></button></td>")
                               .appendTo("#tblUnits1 tbody tr:nth-last-child(2)");
                    $(this).closest('tr').next('tr').find("[name*='txtDocCode']").val('');
                    trLast.find("[name *= 'txtDocCode']").attr({
                        "name": ("txtDocCode" + counter)
                    });
                    trLast.find("[name *= 'txtDocName']").attr({
                        "name": ("Name" + counter)
                    });
                    trLast.find("[name *= 'txtUniCodeName']").attr({
                        "name": ("txtUniCodeName" + counter)
                    });
                    trLast.find(":first").text(counter);
                }
            }
            counter++;
        });

                     
        /*Refresh */
        $("#btnCancel").click(function () {
            if ($("#tblUnits1 > tbody > tr").length > 1) {
                $("#tblUnits1 tbody tr td:last-child").remove();
            }
            $("#tblUnits1 tbody").find("tr:gt(0)").remove();

            $("[name*='txtDocCode']").val('');
            $("[name*='txtDocName']").val('');
          //  $("[name*='txtUniCodeName']").val('');
            $("#tblUnits1").hide();
            $("#btnAdd").prop("disabled", false);
            $("#btnCancel").prop("disabled", true);
            $("#btnSave").prop("disabled", true);
            $("[name*='Edit']").prop('disabled', false);
            $("[name*='Delete']").prop('disabled', false);
            $("#tbldiv").show();
        });
        /*Save Unit Table */
        $("#btnSave").click(function () {
            debugger;
            var Doks = {
                DocumentsDetailnew: []
            };
            $("#tblUnits1 tbody tr").each(function (index, item) {
                var StsCode = $(this).find("[name*='txtDocCode']").val();
                var StsName = $(this).find("[name*='txtDocName']").val();
               // var StsUniCodeName = $(this).find("[name*='txtUniCodeName']").val();
                if ((StsCode != "") && (StsName != "")) {
                    var DocumentsDetail = {
                        DocCode: StsCode,
                        DocName: StsName,
                       // UniCodeName: StsUniCodeName
                    };
                    Doks.DocumentsDetailnew.push(DocumentsDetail);
                }
            });
            var validationResult = ValidateForm(Doks);
            if (validationResult.formValid) {
                $.post("/Documents/SaveDoks", Doks).done(function (response) {
                    if (response.Drecord == null) {

                        response.Drecord = 0;
                        $("#tbldiv").show();

                    }
                    $("#tblUnits1 tbody tr").each(function (index, item) {
                        var tr = $(this).closest("tr");
                        var codeAdd = $(tr).find("[name*='txtDocCode']").val().trim();
                        var nameAdd = $(tr).find("[name*='txtDocName']").val().trim();
                      //  var unicodenameAdd = $(tr).find("[name*='txtUniCodeName']").val().trim();
                        if (response.Drecord.length > 0) {
                            var ary1 = [];
                            ary1 = response.Drecord;
                            if ($.inArray(codeAdd, ary1) < 0 && codeAdd != '' && nameAdd != '') {
                                $(this).closest('tr').remove();
                                var counter = $("#Counter").val();
                                var firstRow = $('#tblUnits tbody tr:first');

                                var newRow = "<tr><td>" + codeAdd + "</td><td>" + nameAdd +
                                    "</td> ";
                                newRow += "</td><td><button class='btn btn-primary' name='Edit" + counter + "' disabled>Edit</button>&nbsp;<button class='btn btn-danger' name='DeleteNew" + counter +
                                    "' disabled>Delete</button><input type='hidden' name='EditMode" + counter + "' value='true'><input name='item.CmpyCode' type='hidden' value='" + response.CmpyCode +
                                    "'></td></tr>";
                                $(firstRow).after(newRow);
                            }
                            else if (codeAdd != '') {
                                $(this).closest('tr').css("background", "red");
                            }
                            else {
                                $(this).closest('tr').css("background", "");
                            }
                        }
                        else {
                            $("#tblUnits1 tbody").find("tr:not(:last)").remove();
                            $("[name*='txtDocCode']").val();
                            $("[name*='txtDocName']").val();
                           

                            $("#tblUnits1").hide();
                            $("#btnAdd").prop("disabled", false);
                            $("#btnCancel").prop("disabled", true);
                            $("#btnSave").prop("disabled", true);
                            if (codeAdd != '' && nameAdd != '') {
                                var counter = $("#Counter").val();
                                var firstRow = $('#tblUnits tbody tr:first');
                                var newRow = "<tr><td>" + codeAdd + "</td><td>" + nameAdd +
                                    "</td> ";
                                newRow += "</td><td><button class='btn btn-primary' name='Edit" + counter + "' disabled><span class='glyphicon glyphicon-pencil'></span></button>&nbsp;<button class='btn btn-danger' name='DeleteNew" + counter +
                                    "' disabled><span class='glyphicon glyphicon-trash'></span></button><input type='hidden' name='EditMode" + counter + "' value='true'><input name='item.CmpyCode' type='hidden' value='" + response.CmpyCode +
                                    "'></td></tr>";
                                //newRow += "</tr>";
                                $(firstRow).after(newRow);
                            }
                            $("[name*='Edit']").prop('disabled', false)
                            $("[name*='Delete']").prop('disabled', false)

                        }
                    });
                });
            }
            else {
                $("#ErrorMessage").show().find("strong").text(ErrorMessage);
            }
        });

        function ValidateForm(Doks) {
            var response = {
                ErrorMessage: "",
                formValid: false
            };
            //var dupr = false;
            //$("#tblUnits1 tbody tr").each(function (index, item) {
            //    var tr = $(this).closest('tr');
            //    if ($.inArray(tr.find("[name *= 'txtDocCode']").val(), drec) >= 0 && tr.find("[name *= 'txtDocCode']").val() !='') {
            //        tr.css("background", "red");
            //        tr.find("[name *= 'txtDocCode']").focus();
            //        dupr = true;
            //    }
            //    else {
            //        tr.css("background", "");
            //    }
            //});

            //if (dupr == true) {
            //    response.ErrorMessage += "Please Enter Unique Status code Details";
            //}
            if (Doks.DocumentsDetailnew.length == 0) {
                response.ErrorMessage += "Please Enter atleast One Status code Details";
            }
            if (response.ErrorMessage.length == 0) {
                response.formValid = true;
            }

            return response;
        }
        $("#tblUnits1").on("click", "[name*='btnDelete']", function () {
            $(this).closest("tr").remove();
        });

        $("#tblUnits").on("click", "[name^='Add']", function () {
            var counter = $("#Counter").val();
            var hdnAddMode = $(this).parent().find('input:hidden:first');
            var hdnCmpyCode = $(this).parent().find("[name='item.CmpyCode']").val();
            var editButton = $(this).parent().find("[name='Add" + counter + "']");
            var tr = $(this).closest("tr");
            var index = $(this).attr("name").substring(4);
            var doccodeTd = $(tr).find("td:eq(0)");
            var docnameTd = $(tr).find("td:eq(1)");
           
            //var unitTypeTd = $(tr).find("td:eq(3)");

            if (hdnAddMode.val() == "true") {
                var doccodeAdd = $(tr).find("[name*='txtDocCode']").val().trim();
                var docnameAdd = $(tr).find("[name*='txtDocName']").val().trim();
               

                var Doks = {
                    CmpyCode: hdnCmpyCode,
                    DocCode: doccodeAdd,
                    DocName: docnameAdd,
                   
                    EditFlag: false
                };
                if (doccodeAdd && hdnCmpyCode) {
                    $.post("/Documents/SaveDoks", Doks).done(function (response) {
                        console.log(response);
                        doccodeTd.text(response.DocCode);
                        docnameTd.text(response.DocName);
                      
                       
                        hdnAddMode.val("false");
                        editButton.attr("name", ("Edit" + counter)).text("Edit");
                        hdnAddMode.attr("name", ("EditMode" + counter)).val("false");
                        $("#btnAdd").prop('disabled', false);
                    });
                } else {
                    alert();
                }
            }
        });
        $(document).ajaxError(function (event, jqxhr, settings, thrownError) {
            console.log(thrownError);
        });

        $("#tblUnits").on("click", "[name^='DeleteNew']", function () {
            $(this).closest("tr").remove();
        });

        $("#tblUnits").on("click", "[name^='Edit']", function () {
            var n = EzAuthenticationBtn("/DutyResume", "EditIt");
            if (n == 1) {
                var counter = $("#Counter").val();
                var hdnEditMode = $(this).parent().find('input:hidden:first');
                var hdnCmpyCode = $(this).parent().find("[name='item.CmpyCode']").val();
                var tr = $(this).closest("tr");
                var hdnDocCode = $(tr).find("td:eq(0)").text().trim();
                var index = $(this).attr("name").substring(4);
                var docnameTd = $(tr).find("td:eq(1)");

                var editButton = $(this);

                if (hdnEditMode.val() == "true") {
                    var docnameEdit = $(tr).find("[name*='txtDocName']").val().trim();

                    var Doks = {
                        CmpyCode: hdnCmpyCode,
                        DocCode: hdnDocCode,
                        DocName: docnameEdit,
                        EditFlag: true
                    };

                    $.post("/Documents/SaveDoks", Doks).done(function (response) {
                        docnameTd.text(response.DocName);

                        hdnEditMode.val("false");
                        //editButton.text("Edit");
                        editButton.html('<span class="glyphicon glyphicon-pencil"></span>');
                        editButton.attr('title', 'Edit');
                        tr.find("[name^='Delete']").html('<span class="glyphicon glyphicon-trash"></span>');
                        tr.find("[name^='Delete']").attr('title', 'Delete');
                        //tr.find("[name^='Delete']").text("Delete");
                        tableDis("F");
                    });
                    $(document).ajaxError(function (event, jqxhr, settings, thrownError) {
                        console.log(thrownError);
                    });
                } else {
                    var docname = $(tr).find("td:eq(1)").text();
                    $('#inpdocname').val(docname.trim());
                    docnameTd.html("<input type='text' name='txtDocName" + index + "' value='" + docname.trim() + "' />");



                    $(this).html('<span class="glyphicon glyphicon-upload" ></span>');
                    $(this).attr('title', 'Update');
                    hdnEditMode.val("true");

                    tableDis("T");
                    $(this).attr("disabled", false);
                    tr.find("[name^='Delete']").prop("disabled", false);

                    tr.find("[name^='Delete']").html('<span class="glyphicon glyphicon-remove"></span>')
                    tr.find("[name^='Delete']").attr('title', 'Cancel');

                }
            }
        });

        $("#tblUnits").on("click", "[name^='Delete']", function () {
            var n = EzAuthenticationBtn("/DutyResume", "DeleteIt");
            if (n == 1) {
                var tr = $(this).closest("tr");
                var hdnCmpyCode = $(this).parent().find("[name='item.CmpyCode']").val();
                var doccodeTd = $(tr).find("td:eq(0)");
                var hdnMode = $(this).parent().find('input:hidden:first');
                var doccode = "";
                if (hdnMode.val() == "false") {

                    doccode = $(tr).find("td:eq(0)").text().trim();
                    $.getJSON("/DeleteDoks", { DocCode: doccode, CmpyCode: hdnCmpyCode }).done(function (data) {
                        if (data.DeleteFlag) {
                            tr.remove();
                        }
                    });
                }
                else {
                    var nameTd = $(tr).find("td:eq(1)");
                    //var unicodenameTd = $(tr).find("td:eq(2)");
                    var nameEdit = $('#inpdocname').val(); //$(tr).find("[name*='txtDocName']").val().trim();
                    //var unicodenameEdit = $(tr).find("[name*='txtUniCodeName']").val().trim();
                    var hdnEditMode = $(this).parent().find('input:hidden:first');
                    nameTd.html(nameEdit);

                    //var unicodename = $(tr).find("td:eq(2)").text();
                    //unicodenameTd.html(unicodenameEdit);

                    //tr.find("[name^='Edit']").text("Edit");
                    tr.find("[name^='Edit']").html('<span class="glyphicon glyphicon-pencil"></span>');
                    tr.find("[name^='Edit']").attr('title', 'Edit');
                    $(this).html('<span class="glyphicon glyphicon-trash"></span>');
                    //$(this).text("Delete");
                    $(this).attr('title', 'Delete');
                    hdnEditMode.val("false");

                    tableDis("F");
                }
            }
        });
    });

    var k = 0;
    function tableDis(k) {
        if (k == "T") {
            $("#tblUnits tbody tr").find("[name^='Edit']").prop("disabled", true);
            $("#tblUnits tbody tr").find("[name^='Delete']").prop("disabled", true);
            $("#btnAdd").prop('disabled', true);
        }
        else {
            $("#tblUnits tbody tr").find("[name^='Edit']").prop("disabled", false);
            $("#tblUnits tbody tr").find("[name^='Delete']").prop("disabled", false);
            $("#btnAdd").prop('disabled', false);

        }
    }
</script>

<script>
$(document).ready(function(){
    //$('[data-toggle="tooltip"]').tooltip();
    $(".edit").attr('title', 'Edit');
    $(".delete").attr('title', 'Delete');
});
</script>

<br />
<ol class="breadcrumb">
    <li class="active  strong1">
        <strong>Documents Master</strong>
    </li>
</ol>

<div class="title-action">
    <button class="btn btn-primary btn1" id="btnAdd"><span class="glyphicon glyphicon-plus-sign"></span>&nbsp;Add</button>

    <button type="submit" class="btn btn-primary btn1" id="btnSave" disabled><span class="glyphicon glyphicon-floppy-disk"></span>&nbsp; Save</button>



    <button class="btn btn-warning btn1" id="btnCancel"><span class="glyphicon glyphicon-off"></span>&nbsp; Cancel</button>

    <input type="hidden" id="hdnOperationMode" value="" />

</div>

<div class="panel panel-default">
    <div class="panel-body">
        <input id="inpdocname" type="hidden"/>
        <table class="table table-bordered" id="tblUnits1">
    <thead>
        <tr class="tr">
            <th>
                @Html.DisplayNameFor(model => model.DocCode)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.DocName)
            </th>
          

            <th></th>
        </tr>
    </thead>

    <tbody>
        <tr>
            <td>
                <div class="grid-group">
                    @Html.TextBox(string.Concat("txtDocCode", counter), null, new { @class = "grid-control" })
                </div>
            </td>
            <td>
                <div class="grid-group">
                    @Html.TextBox(string.Concat("txtDocName", counter), null, new { @class = "grid-control" })
                </div>
            </td>
            

        </tr>
    </tbody>
</table>

        <div id="tbldiv">
            <table class="table" id="tblUnits">
                <thead>
                    <tr class="tr">
                        <th>
                            @Html.DisplayNameFor(model => model.DocCode)
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.DocName)
                        </th>
                      
                        <th></th>
                      
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>
                                @Html.DisplayFor(modelItem => item.DocCode)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.DocName)
                            </td>
                           

                            <td>
                                <button class="btn btn-primary" data-toggle="tooltip" title="Edit" name="@string.Concat("Edit",counter)"><span class="glyphicon glyphicon-pencil"></span></button>
                                <button class="btn btn-danger" data-toggle="tooltip" title="Delete" name="@string.Concat("Delete",counter)"><span class="glyphicon glyphicon-trash"></span></button>
                                <input type="hidden" name="@string.Concat("EditMode",counter)" value="false" />
                                @Html.HiddenFor(m => item.CmpyCode)
                            </td>
                        </tr>
                        counter++;
                    }
                </tbody>

            </table>

            </div>


            @Html.Hidden("Counter", counter)
        </div>
</div>






